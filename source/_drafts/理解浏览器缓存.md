---
title: 理解浏览器缓存
date: 2020/03/09 22:15:00
updated: 2020/03/09 22:15:00
categories: 
- 前端知识
tags: 
- 浏览器
- 缓存
---

# 简介
发布一个新版本页面后，如果未加干预，用户往往还会看到更新前的样式，这就是浏览器端的缓存在“捣乱”了，本文写于2020年3月，介绍浏览器的缓存机制，还会告诉你如何在需要的时候使用或丢弃缓存。

<!-- more -->

# 什么是浏览器缓存
我们知道，前端代码100%地运行在浏览器端，当用户打开一个页面时，需要下载 html, js, css 和一堆图片，页面在短期内一般不会有改变，通常，浏览器会聪明地记录这些**静态资源**的相关信息，保存在临时目录中的css和图片等等，都不会被删除，这就是缓存的一种。当用户再次访问同样的页面时，浏览器会优先使用缓存，找不到缓存时，才会从互联网重新下载。此时虽然页面的样式已经在服务端更新了，但浏览器认为本地已经有了这份样式，就不会再重新下载新样式，用户看到的就是老版本的页面了。

- 浏览器缓存（Browser Caching）是为了节约网络的资源加速浏览，浏览器在用户磁盘上对最近请求过的文档进行存储，当访问者再次请求这个页面时，浏览器就可以从本地磁盘显示文档，这样就可以加速页面的阅览。
- 浏览器缓存能够显著加快页面加载速度，节约流量，也能减轻服务端的访问压力。

# 缓存的方式
要想更好地利用缓存，我们需要知道缓存的工作方式。

缓存是在服务器响应浏览器发出的请求时建立的，每次浏览器发送请求时，都会先尝试寻找缓存，拿到服务器发送的响应后，再根据响应报文中的缓存标识来决定是否要建立缓存。

浏览器的缓存分为两种：**强缓存**和**协商缓存**

## 强缓存
强缓存就是指，浏览器不向服务端发送请求，直接从缓存读取信息，这时对应的请求会返回状态码200 。

强缓存由 **Expires(HTTP/1)** 和 **Cache-Control(HTTP/1.1)** 这两种Header控制。

### Expires
这个字段是一个GMT格式的字符串，比如Mon, Mar 09 2020 23:11:29 GMT，如果发送请求时，时间（本地时间）超过了这个时间，那么缓存就会失效，浏览器会到服务器去获取资源，否则缓存有效，返回状态码304 。

### Cache-Control
这个字段在HTTP/1.1中生效，这也是浏览器默认的协议版本，它可以在**请求头**或**响应头**中配置。如果 Cache-Control 与 Expires 同时存在，**那么 Cache-Control 的优先级更高，只有 Cache-Control 会生效**

当 `Cache-Control: max-age=300` 时，也就意味着缓存内容将在300秒后失效。

Cache-Control经常用到这些值：

- **private** 默认值，表明响应只能被单个用户缓存，不能作为共享缓存（即代理服务器不能缓存它）。私有缓存可以缓存响应内容
- **public** 表明响应可以被任何对象（包括：发送请求的客户端，代理服务器，等等）缓存，即使是通常不可缓存的内容（例如，该响应没有max-age指令或Expires消息头）
- **no-cache** 资源会被缓存，但所有的请求都要发到服务端，经过服务端验证来决定是否有效（协商缓存）
- **no-store** 所有资源都不会被缓存
- **max-age=number** 缓存在一定时期内有效，max-age的取值不能超过31536000（一年）

关于 Cache-Control, 更详细的内容可以看 [MDN](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Cache-Control)

## 协商缓存
强缓存只依赖本地的信息来判断缓存是否有效，有时我们需要由服务端来决定是否使用缓存，这时候就要用到协商缓存。

协商缓存主要由 **Last-Modified / If-Modified-Since 和 Etag / If-None-Match** 字段控制。

### Last-Modifield

### If-Modified-Since

### Etag

### If-None-Match

<!-- TODO: 这里配个流程图说明工作流程 -->
# 如何判断是否使用了缓存
<!-- TODO: 看chrome dev-tool -->

# 如何合理利用浏览器缓存
<!-- TODO: 这里需要具体案例，比如用vue打包，webpack怎么处理，nginx怎么处理，经常变的东西，不容易变，不更新也没事的东西怎么处理 -->
# 用户如何丢弃缓存
<!-- ctrl+f5强刷，chrome dev-tool下长按刷新按钮强刷，disk cache查看，浏览器清除缓存 -->